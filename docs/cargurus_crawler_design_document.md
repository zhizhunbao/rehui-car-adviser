# ğŸš— CarGurusCrawler é‡æ„è®¾è®¡æ–‡æ¡£

## ğŸ“– æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº† CarGurusCrawler çš„é‡æ„è®¾è®¡ï¼ŒåŒ…æ‹¬æ¶æ„è®¾è®¡ã€ç±»èŒè´£åˆ’åˆ†ã€è°ƒç”¨é€»è¾‘ã€ä½¿ç”¨ç¤ºä¾‹ç­‰ã€‚é‡æ„åçš„ç³»ç»Ÿé‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œéµå¾ªå•ä¸€èŒè´£åŸåˆ™ï¼Œæé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025å¹´1æœˆ27æ—¥  
**ç»´æŠ¤è€…**: Rehui Car Adviser å¼€å‘å›¢é˜Ÿ

---

## ğŸ¯ é‡æ„ç›®æ ‡

### è®¾è®¡åŸåˆ™
1. **å•ä¸€èŒè´£åŸåˆ™**: æ¯ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªç‰¹å®šåŠŸèƒ½
2. **å¼€é—­åŸåˆ™**: å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
3. **ç»„åˆæ¨¡å¼**: é€šè¿‡ç»„åˆå®ç°å¤æ‚åŠŸèƒ½
4. **å‘åå…¼å®¹**: ä¿æŒå¯¹å¤–æ¥å£ä¸å˜
5. **ä»£ç å¤ç”¨**: é¿å…é‡å¤ä»£ç 

### é‡æ„ç›®æ ‡
- âœ… å°†å¤§å‹ç±»æ‹†åˆ†ä¸ºå¤šä¸ªä¸“é—¨çš„å°ç±»
- âœ… æé«˜ä»£ç å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§
- âœ… å¢å¼ºç³»ç»Ÿçš„å¯æµ‹è¯•æ€§
- âœ… é™ä½ä»£ç è€¦åˆåº¦
- âœ… æé«˜ä»£ç å¤ç”¨æ€§

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CarGurusCrawler                          â”‚
â”‚                    (ä¸»åè°ƒå™¨)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚             â”‚             â”‚
        â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Config    â”‚ â”‚ URLBuilder  â”‚ â”‚DataExtractorâ”‚
â”‚  (é…ç½®ç®¡ç†)  â”‚ â”‚ (URLæ„å»º)   â”‚ â”‚ (æ•°æ®æå–)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚             â”‚             â”‚
        â–¼             â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DataSaver  â”‚ â”‚BrandCollectorâ”‚ â”‚ModelCollectorâ”‚
â”‚  (æ•°æ®ä¿å­˜)  â”‚ â”‚ (å“ç‰Œæ”¶é›†)   â”‚ â”‚ (è½¦å‹æ”¶é›†)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚CarSearcher  â”‚
              â”‚ (è½¦æºæœç´¢)   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç±»èŒè´£åˆ’åˆ†

| ç±»å | èŒè´£ | ä¸»è¦æ–¹æ³• |
|------|------|----------|
| `CarGurusConfig` | é…ç½®ç®¡ç† | `get_city_zip_codes()`, `get_make_code()` |
| `CarGurusURLBuilder` | URLæ„å»º | `build_search_url()`, `build_brand_url()`, `build_model_url()` |
| `CarGurusDataExtractor` | æ•°æ®æå– | `extract_listing_data()`, `extract_year_from_title()` |
| `CarGurusDataSaver` | æ•°æ®ä¿å­˜ | `save_brands_data()`, `save_models_data()` |
| `CarGurusBrandCollector` | å“ç‰Œæ”¶é›† | `collect_brands()` |
| `CarGurusModelCollector` | è½¦å‹æ”¶é›† | `collect_models_for_brand()` |
| `CarGurusCarSearcher` | è½¦æºæœç´¢ | `search_cars()` |
| `CarGurusCrawler` | ä¸»åè°ƒå™¨ | `search_cars()`, `collect_brands()`, `collect_models_for_brand()` |

---

## ğŸ“‹ è¯¦ç»†è®¾è®¡

### 1. CarGurusConfig (é…ç½®ç®¡ç†ç±»)

**èŒè´£**: ç®¡ç†åŸå¸‚ZIPä»£ç å’Œå“ç‰Œä»£ç æ˜ å°„

```python
class CarGurusConfig:
    """CarGurus é…ç½®ç®¡ç†ç±»"""
    
    # ä¸»è¦åŸå¸‚åŠå…¶ZIPä»£ç 
    MAJOR_CITIES = {
        'toronto': ['M5V', 'M6G', 'M4Y', 'M5A', 'M5H', 'M5B', 'M5C', 'M5E'],
        'vancouver': ['V6B', 'V6Z', 'V6E', 'V6H', 'V6J', 'V6K', 'V6L', 'V6M'],
        # ... æ›´å¤šåŸå¸‚
    }
    
    # å“ç‰Œä»£ç æ˜ å°„
    MAKE_CODES = {
        'toyota': 'm7', 'honda': 'm6', 'nissan': 'm12',
        # ... æ›´å¤šå“ç‰Œ
    }
    
    @classmethod
    def get_city_zip_codes(cls, city_name: str) -> List[str]:
        """æ ¹æ®åŸå¸‚åç§°è·å–ZIPä»£ç åˆ—è¡¨"""
        
    @classmethod
    def get_make_code(cls, make_name: str) -> str:
        """æ ¹æ®å“ç‰Œåç§°è·å–å“ç‰Œä»£ç """
```

**è®¾è®¡ç‰¹ç‚¹**:
- ä½¿ç”¨ç±»æ–¹æ³•ï¼Œæ— éœ€å®ä¾‹åŒ–
- æ”¯æŒç²¾ç¡®åŒ¹é…å’Œéƒ¨åˆ†åŒ¹é…
- æä¾›é»˜è®¤å€¼å¤„ç†

### 2. CarGurusURLBuilder (URLæ„å»ºç±»)

**èŒè´£**: æ„å»ºå„ç§ç±»å‹çš„CarGurus URL

```python
class CarGurusURLBuilder:
    """CarGurus URLæ„å»ºå™¨"""
    
    BASE_URL = "https://www.cargurus.ca/Cars/inventorylisting/viewDetailsFilterViewInventoryListing.action"
    
    @classmethod
    def build_search_url(cls, parsed_query: ParsedQuery, distance: int = 100) -> str:
        """æ„å»ºè½¦æºæœç´¢URL"""
        
    @classmethod
    def build_brand_url(cls, brand_code: str, zip_code: str, distance: int = 100) -> str:
        """æ„å»ºå“ç‰Œé¡µé¢URL"""
        
    @classmethod
    def build_model_url(cls, model_code: str, zip_code: str, distance: int = 100) -> str:
        """æ„å»ºè½¦å‹é¡µé¢URL"""
```

**è®¾è®¡ç‰¹ç‚¹**:
- ç»Ÿä¸€çš„URLæ„å»ºé€»è¾‘
- æ”¯æŒå‚æ•°åŒ–é…ç½®
- ä½¿ç”¨ç±»æ–¹æ³•ï¼Œä¾¿äºè°ƒç”¨

### 3. CarGurusDataExtractor (æ•°æ®æå–ç±»)

**èŒè´£**: ä»HTMLå…ƒç´ ä¸­æå–ç»“æ„åŒ–æ•°æ®

```python
class CarGurusDataExtractor:
    """CarGurus æ•°æ®æå–å™¨"""
    
    @staticmethod
    def extract_listing_data(listing) -> Dict[str, str]:
        """æå–å•ä¸ªlistingçš„æ•°æ®"""
        
    @staticmethod
    def extract_year_from_title(title: str) -> int:
        """ä»æ ‡é¢˜ä¸­æå–å¹´ä»½"""
```

**è®¾è®¡ç‰¹ç‚¹**:
- ä½¿ç”¨é™æ€æ–¹æ³•ï¼Œæ— çŠ¶æ€
- å®‰å…¨çš„å…ƒç´ è®¿é—®
- æ•°æ®æ¸…æ´—å’Œæ ¼å¼åŒ–

### 4. CarGurusDataSaver (æ•°æ®ä¿å­˜ç±»)

**èŒè´£**: å°†æ•°æ®ä¿å­˜ä¸ºJSONå’ŒCSVæ ¼å¼

```python
class CarGurusDataSaver:
    """CarGurus æ•°æ®ä¿å­˜å™¨"""
    
    def __init__(self, output_dir: Path):
        self.output_dir = output_dir
        self.output_dir.mkdir(parents=True, exist_ok=True)
    
    async def save_brands_data(self, brands: List[Dict[str, str]], date_str: str):
        """ä¿å­˜å“ç‰Œæ•°æ®åˆ°æ–‡ä»¶"""
        
    async def save_models_data(self, models: List[Dict[str, str]], brand_name: str, date_str: str):
        """ä¿å­˜è½¦å‹æ•°æ®åˆ°æ–‡ä»¶"""
```

**è®¾è®¡ç‰¹ç‚¹**:
- æ”¯æŒå¤šç§æ ¼å¼è¾“å‡º
- è‡ªåŠ¨åˆ›å»ºç›®å½•
- å¼‚æ­¥æ“ä½œ

### 5. CarGurusBrandCollector (å“ç‰Œæ”¶é›†å™¨)

**èŒè´£**: ä¸“é—¨è´Ÿè´£æ”¶é›†å“ç‰Œæ•°æ®

```python
class CarGurusBrandCollector:
    """CarGurus å“ç‰Œæ•°æ®æ”¶é›†å™¨"""
    
    def __init__(self, profile_name: str, zip_code: str, distance: int = 100):
        self.profile_name = profile_name
        self.zip_code = zip_code
        self.distance = distance
    
    async def collect_brands(self, limit: int = None) -> List[Dict[str, str]]:
        """æ”¶é›† CarGurus å“ç‰Œæ•°æ®"""
        
    async def _extract_brands_from_page(self, driver, limit: int = None) -> List[Dict[str, str]]:
        """ä»é¡µé¢æå–å“ç‰Œæ•°æ®"""
        
    async def _handle_captcha(self, driver) -> bool:
        """å¤„ç†æ»‘å—éªŒè¯ç """
        
    def _simulate_human_behavior(self, driver):
        """æ¨¡æ‹Ÿäººç±»æµè§ˆè¡Œä¸º"""
```

**è®¾è®¡ç‰¹ç‚¹**:
- åŒ…å«éªŒè¯ç å¤„ç†é€»è¾‘
- æ”¯æŒå¤šç§æå–ç­–ç•¥
- äººç±»è¡Œä¸ºæ¨¡æ‹Ÿ

### 6. CarGurusModelCollector (è½¦å‹æ”¶é›†å™¨)

**èŒè´£**: ä¸“é—¨è´Ÿè´£æ”¶é›†è½¦å‹æ•°æ®

```python
class CarGurusModelCollector:
    """CarGurus è½¦å‹æ•°æ®æ”¶é›†å™¨"""
    
    def __init__(self, profile_name: str, zip_code: str, distance: int = 100):
        self.profile_name = profile_name
        self.zip_code = zip_code
        self.distance = distance
    
    async def collect_models_for_brand(self, brand_name: str, limit: int = None) -> List[Dict[str, str]]:
        """æ”¶é›†æŒ‡å®šå“ç‰Œçš„è½¦å‹æ•°æ®"""
        
    async def _extract_models_from_page(self, driver, brand_name: str, limit: int = None) -> List[Dict[str, str]]:
        """ä»é¡µé¢æå–è½¦å‹æ•°æ®"""
```

**è®¾è®¡ç‰¹ç‚¹**:
- å¤ç”¨éªŒè¯ç å¤„ç†é€»è¾‘
- æ”¯æŒå“ç‰Œç‰¹å®šçš„è½¦å‹æ”¶é›†
- ç¡¬ç¼–ç å¤‡ç”¨æ–¹æ¡ˆ

### 7. CarGurusCarSearcher (è½¦æºæœç´¢å™¨)

**èŒè´£**: ä¸“é—¨è´Ÿè´£æœç´¢è½¦æº

```python
class CarGurusCarSearcher:
    """CarGurus è½¦æºæœç´¢å™¨"""
    
    def __init__(self, profile_name: str):
        self.profile_name = profile_name
    
    async def search_cars(self, parsed_query: ParsedQuery, max_results: int = 20) -> List[CarListing]:
        """æœç´¢è½¦æº"""
        
    async def _handle_captcha(self, driver) -> bool:
        """å¤„ç†æ»‘å—éªŒè¯ç """
        
    def _simulate_human_behavior(self, driver):
        """æ¨¡æ‹Ÿäººç±»æµè§ˆè¡Œä¸º"""
```

**è®¾è®¡ç‰¹ç‚¹**:
- ä¸CarGurusScraperå…¼å®¹çš„æ¥å£
- è¿”å›æ ‡å‡†åŒ–çš„CarListingå¯¹è±¡
- å¤ç”¨éªŒè¯ç å¤„ç†é€»è¾‘

### 8. CarGurusCrawler (ä¸»åè°ƒå™¨)

**èŒè´£**: ç»„åˆå„ä¸ªç»„ä»¶ï¼Œæä¾›ç»Ÿä¸€çš„å¯¹å¤–æ¥å£

```python
class CarGurusCrawler:
    """CarGurus ä¸»çˆ¬è™«åè°ƒå™¨ - é‡æ„ç‰ˆæœ¬"""
    
    def __init__(self, date_str: str, make_name: str, zip_code: str, profile_name: str = None):
        # åˆå§‹åŒ–å„ä¸ªç»„ä»¶
        self.data_saver = CarGurusDataSaver(self.output_dir)
        self.brand_collector = CarGurusBrandCollector(self.profile_name, zip_code, self.distance)
        self.model_collector = CarGurusModelCollector(self.profile_name, zip_code, self.distance)
        self.car_searcher = CarGurusCarSearcher(self.profile_name)
    
    async def search_cars(self, parsed_query: ParsedQuery, max_results: int = 20) -> List[CarListing]:
        """æœç´¢è½¦æº - ä¸CarGurusScraperå…¼å®¹çš„æ¥å£"""
        return await self.car_searcher.search_cars(parsed_query, max_results)
    
    async def collect_brands(self, limit: int = None) -> List[Dict[str, str]]:
        """æ”¶é›† CarGurus å“ç‰Œæ•°æ®"""
        return await self.brand_collector.collect_brands(limit)
    
    async def collect_models_for_brand(self, brand_name: str, limit: int = None) -> List[Dict[str, str]]:
        """æ”¶é›†æŒ‡å®šå“ç‰Œçš„è½¦å‹æ•°æ®"""
        return await self.model_collector.collect_models_for_brand(brand_name, limit)
```

**è®¾è®¡ç‰¹ç‚¹**:
- ç»„åˆæ¨¡å¼å®ç°
- ä¿æŒå‘åå…¼å®¹æ€§
- ç»Ÿä¸€çš„é…ç½®ç®¡ç†

---

## ğŸ”„ è°ƒç”¨é€»è¾‘

### 1. Web API è°ƒç”¨åœºæ™¯

```python
# åœ¨ SearchService ä¸­çš„è°ƒç”¨
class SearchService:
    def __init__(self):
        # æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ä¿®å¤åˆå§‹åŒ–é—®é¢˜
        self.cargurus_crawler = None  # å»¶è¿Ÿåˆå§‹åŒ–
    
    async def search_cars(self, request: SearchRequest):
        # 1. å»¶è¿Ÿåˆå§‹åŒ–çˆ¬è™«
        if not self.cargurus_crawler:
            date_str = time.strftime('%Y%m%d')
            self.cargurus_crawler = CarGurusCrawler(date_str, "Toyota", "M5V")
        
        # 2. AIè§£æç”¨æˆ·æŸ¥è¯¢
        parsed_query = await self.gemini_service.parse_user_query(request.query)
        
        # 3. è°ƒç”¨çˆ¬è™«æœç´¢è½¦æº
        cars = await self.cargurus_crawler.search_cars(parsed_query, max_results=20)
        
        # 4. è¿”å›æœç´¢ç»“æœ
        return SearchResponse(success=True, data=cars)
```

**è°ƒç”¨é“¾**:
```
ç”¨æˆ·è¯·æ±‚ â†’ SearchService.search_cars() 
â†’ CarGurusCrawler.search_cars() 
â†’ CarGurusCarSearcher.search_cars()
â†’ CarGurusURLBuilder.build_search_url()
â†’ CarGurusDataExtractor.extract_listing_data()
```

### 2. å‘½ä»¤è¡Œè„šæœ¬è°ƒç”¨åœºæ™¯

```python
# å“ç‰Œæ•°æ®æ”¶é›†
async def collect_brands(limit=None, test_mode=False):
    # 1. åˆ›å»ºçˆ¬è™«å®ä¾‹
    date_str = time.strftime('%Y%m%d')
    crawler = CarGurusCrawler(date_str, "Toyota", "M5V")
    
    # 2. æ”¶é›†å“ç‰Œæ•°æ®
    brands = await crawler.collect_brands(limit=limit)
    
    # 3. ä¿å­˜æ•°æ®
    await crawler.save_brands_data(brands)
    
    return brands

# è½¦å‹æ•°æ®æ”¶é›†
async def collect_models_for_brand(brand_name="Acura", limit=None):
    # 1. åˆ›å»ºçˆ¬è™«å®ä¾‹
    crawler = CarGurusCrawler(date_str, brand_name, "M5V")
    
    # 2. æ”¶é›†è½¦å‹æ•°æ®
    models = await crawler.collect_models_for_brand(brand_name, limit=limit)
    
    # 3. ä¿å­˜æ•°æ®
    await crawler.save_models_data(models, brand_name)
    
    return models
```

**è°ƒç”¨é“¾**:
```
å‘½ä»¤è¡Œ â†’ collect_brands() 
â†’ CarGurusCrawler.collect_brands() 
â†’ CarGurusBrandCollector.collect_brands()
â†’ CarGurusDataSaver.save_brands_data()
```

### 3. ç›´æ¥ä½¿ç”¨åœºæ™¯

```python
async def main():
    # 1. åˆ›å»ºçˆ¬è™«å®ä¾‹
    date_str = time.strftime('%Y%m%d')
    make_name = "Toyota"
    zip_code = "M5V"
    crawler = CarGurusCrawler(date_str, make_name, zip_code)
    
    # 2. è·å–åŸå¸‚ZIPä»£ç 
    city_zips = crawler.get_city_zip_codes("Toronto")
    
    # 3. æ”¶é›†å“ç‰Œæ•°æ®
    brands = await crawler.collect_brands(limit=10)
    if brands:
        await crawler.save_brands_data(brands)
```

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### 1. åŸºæœ¬ä½¿ç”¨

```python
import asyncio
from app.services.cargurus_crawler import CarGurusCrawler

async def basic_usage():
    # åˆ›å»ºçˆ¬è™«å®ä¾‹
    crawler = CarGurusCrawler("20250127", "Toyota", "M5V")
    
    # æœç´¢è½¦æº
    from app.models.schemas import ParsedQuery
    query = ParsedQuery(make="Toyota", model="Camry", year=2020)
    cars = await crawler.search_cars(query, max_results=10)
    
    print(f"æ‰¾åˆ° {len(cars)} è¾†è½¦æº")
    for car in cars:
        print(f"- {car.title}: ${car.price}")

# è¿è¡Œç¤ºä¾‹
asyncio.run(basic_usage())
```

### 2. å“ç‰Œæ•°æ®æ”¶é›†

```python
async def collect_brand_data():
    # åˆ›å»ºçˆ¬è™«å®ä¾‹
    crawler = CarGurusCrawler("20250127", "Toyota", "M5V")
    
    # æ”¶é›†å“ç‰Œæ•°æ®
    brands = await crawler.collect_brands(limit=20)
    
    # ä¿å­˜æ•°æ®
    await crawler.save_brands_data(brands)
    
    print(f"æ”¶é›†äº† {len(brands)} ä¸ªå“ç‰Œ")
    for brand in brands:
        print(f"- {brand['name']}: {brand['value']}")

asyncio.run(collect_brand_data())
```

### 3. è½¦å‹æ•°æ®æ”¶é›†

```python
async def collect_model_data():
    # åˆ›å»ºçˆ¬è™«å®ä¾‹
    crawler = CarGurusCrawler("20250127", "Acura", "M5V")
    
    # æ”¶é›†è½¦å‹æ•°æ®
    models = await crawler.collect_models_for_brand("Acura", limit=10)
    
    # ä¿å­˜æ•°æ®
    await crawler.save_models_data(models, "Acura")
    
    print(f"æ”¶é›†äº† {len(models)} ä¸ªè½¦å‹")
    for model in models:
        print(f"- {model['name']}: {model['count']} è¾†è½¦")

asyncio.run(collect_model_data())
```

### 4. é…ç½®ä½¿ç”¨

```python
# ä½¿ç”¨é…ç½®ç±»
from app.services.cargurus_crawler import CarGurusConfig

# è·å–åŸå¸‚ZIPä»£ç 
toronto_zips = CarGurusConfig.get_city_zip_codes("Toronto")
print(f"Toronto ZIP codes: {toronto_zips}")

# è·å–å“ç‰Œä»£ç 
toyota_code = CarGurusConfig.get_make_code("Toyota")
print(f"Toyota code: {toyota_code}")

# éƒ¨åˆ†åŒ¹é…ç¤ºä¾‹
bmw_code = CarGurusConfig.get_make_code("BMW X5")  # ä¼šåŒ¹é…åˆ° "bmw"
print(f"BMW code: {bmw_code}")
```

---

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

```bash
# å¿…éœ€é…ç½®
GOOGLE_GEMINI_API_KEY=your_gemini_api_key

# å¯é€‰é…ç½®
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_supabase_anon_key
DEBUG=True
```

### åˆå§‹åŒ–å‚æ•°

```python
crawler = CarGurusCrawler(
    date_str="20250127",      # æ—¥æœŸå­—ç¬¦ä¸²ï¼Œç”¨äºæ–‡ä»¶å‘½å
    make_name="Toyota",       # å“ç‰Œåç§°
    zip_code="M5V",          # ZIPä»£ç 
    profile_name=None         # å¯é€‰çš„profileåç§°ï¼Œé»˜è®¤è‡ªåŠ¨ç”Ÿæˆ
)
```

### é…ç½®å‚æ•°

```python
# åœ¨ CarGurusCrawler åˆå§‹åŒ–æ—¶è®¾ç½®
self.distance = 100          # æœç´¢è·ç¦»ï¼ˆå…¬é‡Œï¼‰
self.max_pages = 50         # æœ€å¤§é¡µæ•°
self.per_page = 24          # æ¯é¡µç»“æœæ•°
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. åˆå§‹åŒ–é—®é¢˜ä¿®å¤

**é—®é¢˜**: SearchService ä¸­çš„åˆå§‹åŒ–ç¼ºå°‘å¿…è¦å‚æ•°
```python
# âŒ é”™è¯¯çš„æ–¹å¼
self.cargurus_crawler = CarGurusCrawler()  # ç¼ºå°‘å‚æ•°

# âœ… æ­£ç¡®çš„æ–¹å¼
self.cargurus_crawler = None  # å»¶è¿Ÿåˆå§‹åŒ–

async def search_cars(self, request: SearchRequest):
    if not self.cargurus_crawler:
        date_str = time.strftime('%Y%m%d')
        self.cargurus_crawler = CarGurusCrawler(date_str, "Toyota", "M5V")
```

### 2. å¼‚æ­¥è°ƒç”¨

æ‰€æœ‰ä¸»è¦æ–¹æ³•éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œéœ€è¦ä½¿ç”¨ `await` è°ƒç”¨ï¼š

```python
# âœ… æ­£ç¡®
cars = await crawler.search_cars(query)

# âŒ é”™è¯¯
cars = crawler.search_cars(query)  # ä¼šè¿”å›åç¨‹å¯¹è±¡
```

### 3. é”™è¯¯å¤„ç†

æ¯ä¸ªç»„ä»¶éƒ½æœ‰ç‹¬ç«‹çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼š

```python
try:
    brands = await crawler.collect_brands()
except Exception as e:
    logger.log_result("å“ç‰Œæ”¶é›†å¤±è´¥", f"é”™è¯¯: {str(e)}")
    # å¤„ç†é”™è¯¯
```

### 4. èµ„æºç®¡ç†

ä½¿ç”¨ `async with` ç¡®ä¿æµè§ˆå™¨èµ„æºæ­£ç¡®é‡Šæ”¾ï¼š

```python
async with browser_utils.get_driver(profile_name) as driver:
    # ä½¿ç”¨ driver
    pass  # è‡ªåŠ¨é‡Šæ”¾èµ„æº
```

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. å•å…ƒæµ‹è¯•

```python
import pytest
from app.services.cargurus_crawler import CarGurusConfig, CarGurusURLBuilder

def test_city_zip_codes():
    """æµ‹è¯•åŸå¸‚ZIPä»£ç è·å–"""
    zips = CarGurusConfig.get_city_zip_codes("Toronto")
    assert len(zips) > 0
    assert "M5V" in zips

def test_make_code():
    """æµ‹è¯•å“ç‰Œä»£ç è·å–"""
    code = CarGurusConfig.get_make_code("Toyota")
    assert code == "m7"

def test_url_builder():
    """æµ‹è¯•URLæ„å»º"""
    from app.models.schemas import ParsedQuery
    query = ParsedQuery(make="Toyota", model="Camry")
    url = CarGurusURLBuilder.build_search_url(query)
    assert "cargurus.ca" in url
    assert "m7" in url
```

### 2. é›†æˆæµ‹è¯•

```python
@pytest.mark.asyncio
async def test_crawler_integration():
    """æµ‹è¯•çˆ¬è™«é›†æˆåŠŸèƒ½"""
    crawler = CarGurusCrawler("20250127", "Toyota", "M5V")
    
    # æµ‹è¯•å“ç‰Œæ”¶é›†
    brands = await crawler.collect_brands(limit=5)
    assert len(brands) > 0
    
    # æµ‹è¯•æ•°æ®ä¿å­˜
    await crawler.save_brands_data(brands)
    # éªŒè¯æ–‡ä»¶æ˜¯å¦åˆ›å»º
```

### 3. æ€§èƒ½æµ‹è¯•

```python
import time

@pytest.mark.asyncio
async def test_performance():
    """æµ‹è¯•æ€§èƒ½"""
    crawler = CarGurusCrawler("20250127", "Toyota", "M5V")
    
    start_time = time.time()
    brands = await crawler.collect_brands(limit=10)
    end_time = time.time()
    
    assert end_time - start_time < 30  # åº”è¯¥åœ¨30ç§’å†…å®Œæˆ
    assert len(brands) > 0
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. å¹¶å‘å¤„ç†

```python
async def collect_multiple_brands():
    """å¹¶å‘æ”¶é›†å¤šä¸ªå“ç‰Œæ•°æ®"""
    brands = ["Toyota", "Honda", "BMW", "Mercedes"]
    
    tasks = []
    for brand in brands:
        crawler = CarGurusCrawler("20250127", brand, "M5V")
        task = crawler.collect_brands(limit=5)
        tasks.append(task)
    
    results = await asyncio.gather(*tasks)
    return results
```

### 2. ç¼“å­˜æœºåˆ¶

```python
from functools import lru_cache

class CarGurusConfig:
    @classmethod
    @lru_cache(maxsize=128)
    def get_city_zip_codes(cls, city_name: str) -> List[str]:
        """ç¼“å­˜åŸå¸‚ZIPä»£ç æŸ¥è¯¢ç»“æœ"""
        # ... å®ç°é€»è¾‘
    
    @classmethod
    @lru_cache(maxsize=256)
    def get_make_code(cls, make_name: str) -> str:
        """ç¼“å­˜å“ç‰Œä»£ç æŸ¥è¯¢ç»“æœ"""
        # ... å®ç°é€»è¾‘
```

### 3. èµ„æºæ± ç®¡ç†

```python
class BrowserPool:
    """æµè§ˆå™¨èµ„æºæ± """
    def __init__(self, max_size=5):
        self.max_size = max_size
        self.pool = asyncio.Queue(maxsize=max_size)
    
    async def get_driver(self):
        """è·å–æµè§ˆå™¨å®ä¾‹"""
        if self.pool.empty():
            return await browser_utils.get_driver()
        return await self.pool.get()
    
    async def return_driver(self, driver):
        """å½’è¿˜æµè§ˆå™¨å®ä¾‹"""
        await self.pool.put(driver)
```

---

## ğŸ”® æœªæ¥æ‰©å±•

### 1. å¤šæ•°æ®æºæ”¯æŒ

```python
class MultiSourceCrawler:
    """å¤šæ•°æ®æºçˆ¬è™«"""
    def __init__(self):
        self.cargurus_crawler = CarGurusCrawler(...)
        self.autotrader_crawler = AutoTraderCrawler(...)
        self.kijiji_crawler = KijijiCrawler(...)
    
    async def search_all_sources(self, query):
        """ä»æ‰€æœ‰æ•°æ®æºæœç´¢"""
        tasks = [
            self.cargurus_crawler.search_cars(query),
            self.autotrader_crawler.search_cars(query),
            self.kijiji_crawler.search_cars(query)
        ]
        results = await asyncio.gather(*tasks, return_exceptions=True)
        return self.merge_results(results)
```

### 2. æ•°æ®æŒä¹…åŒ–

```python
class DatabaseSaver:
    """æ•°æ®åº“ä¿å­˜å™¨"""
    def __init__(self, db_connection):
        self.db = db_connection
    
    async def save_cars(self, cars: List[CarListing]):
        """ä¿å­˜è½¦æºåˆ°æ•°æ®åº“"""
        for car in cars:
            await self.db.execute(
                "INSERT INTO cars (title, price, year, mileage, city, link) VALUES (?, ?, ?, ?, ?, ?)",
                (car.title, car.price, car.year, car.mileage, car.city, car.link)
            )
```

### 3. æ™ºèƒ½é‡è¯•æœºåˆ¶

```python
class RetryableCrawler:
    """æ”¯æŒé‡è¯•çš„çˆ¬è™«"""
    def __init__(self, max_retries=3, backoff_factor=2):
        self.max_retries = max_retries
        self.backoff_factor = backoff_factor
    
    async def search_with_retry(self, query):
        """å¸¦é‡è¯•çš„æœç´¢"""
        for attempt in range(self.max_retries):
            try:
                return await self.search_cars(query)
            except Exception as e:
                if attempt == self.max_retries - 1:
                    raise
                await asyncio.sleep(self.backoff_factor ** attempt)
```

---

## ğŸ“‹ æ€»ç»“

### é‡æ„ä¼˜åŠ¿

1. **å•ä¸€èŒè´£**: æ¯ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªç‰¹å®šåŠŸèƒ½ï¼ŒèŒè´£æ¸…æ™°
2. **ä»£ç å¤ç”¨**: éªŒè¯ç å¤„ç†å’Œè¡Œä¸ºæ¨¡æ‹Ÿé€»è¾‘è¢«å¤ç”¨
3. **æ˜“äºç»´æŠ¤**: ä¿®æ”¹æŸä¸ªåŠŸèƒ½åªéœ€è¦ä¿®æ”¹å¯¹åº”çš„ç±»
4. **æ˜“äºæµ‹è¯•**: æ¯ä¸ªç±»å¯ä»¥ç‹¬ç«‹æµ‹è¯•
5. **å‘åå…¼å®¹**: ä¸»æ¥å£ä¿æŒä¸å˜ï¼Œç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹
6. **å¯æ‰©å±•æ€§**: æ–°åŠŸèƒ½å¯ä»¥é€šè¿‡æ·»åŠ æ–°ç±»å®ç°

### è®¾è®¡æ¨¡å¼åº”ç”¨

- **ç»„åˆæ¨¡å¼**: ä¸»åè°ƒå™¨ç»„åˆå„ä¸ªä¸“é—¨ç»„ä»¶
- **ç­–ç•¥æ¨¡å¼**: å¤šç§æ•°æ®æå–ç­–ç•¥
- **å·¥å‚æ¨¡å¼**: URLæ„å»ºå™¨
- **å•ä¾‹æ¨¡å¼**: é…ç½®ç®¡ç†ç±»

### æœ€ä½³å®è·µ

- ä½¿ç”¨ç±»å‹æ³¨è§£æé«˜ä»£ç å¯è¯»æ€§
- å¼‚æ­¥ç¼–ç¨‹æé«˜æ€§èƒ½
- é”™è¯¯å¤„ç†ç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§
- æ—¥å¿—è®°å½•ä¾¿äºè°ƒè¯•å’Œç›‘æ§
- é…ç½®å¤–éƒ¨åŒ–æé«˜çµæ´»æ€§

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025å¹´1æœˆ27æ—¥  
**ç»´æŠ¤è€…**: Rehui Car Adviser å¼€å‘å›¢é˜Ÿ
